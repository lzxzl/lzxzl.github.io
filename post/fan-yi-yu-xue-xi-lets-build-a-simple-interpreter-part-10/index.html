<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
<title>
    ztree
</title>
<!--[if lt IE 9]><script src="//cdn.bootcss.com/html5shiv/r29/html5.js"></script><![endif]-->
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport" />
<meta http-equiv="x-dns-prefetch-control" content="on">
<link rel="dns-prefetch" href="https://fastly.jsdelivr.net">
<meta name="author" content="ztree">
<meta name="description" content="竹杖芒鞋轻胜马，谁怕？一蓑烟雨任平生。">
<meta name="keywords" content="Binary">
<script async src="//instant.page/3.0.0" type="module" defer integrity="sha384-OeDn4XE77tdHo8pGtE1apMPmAipjoxUQ++eeJa6EtJCfHlvijigWiJpD7VDPWXV1"></script>
<link rel="stylesheet" href="https://lzxzl.github.io/styles/main.css" />
<link href="https://fastly.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
<script type="text/javascript" src="https://apps.bdimg.com/libs/jquery/1.7.1/jquery.min.js"></script>

    <link rel="stylesheet" href="https://fastly.jsdelivr.net/gh/itjoker233/Gridea-theme-Chic/assets/media/css/style.min.css" />
    <script src="https://fastly.jsdelivr.net/gh/itjoker233/Gridea-theme-Chic/assets/media/script/tocbot.min.js"></script>
    <script src="https://fastly.jsdelivr.net/gh/itjoker233/Gridea-theme-Chic/assets/media/script/script.min.js"></script>
    <script src="https://fastly.jsdelivr.net/gh/itjoker233/Gridea-theme-Chic/assets/media/script/icon.min.js"></script>
    
            <script src="https://fastly.jsdelivr.net/gh/ITJoker233/ITJoker233.github.io@latest/CDN/js/Card/prism.min.js"></script>
            <link rel="stylesheet" href="https://fastly.jsdelivr.net/gh/ITJoker233/ITJoker233.github.io@latest/CDN/css/Card/prism.min.css" />
            <link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/katex@0.10.1/dist/katex.min.css">
            <script defer src="https://fastly.jsdelivr.net/npm/katex@0.10.1/dist/katex.min.js"></script>
            
                        <!--CDN样式-->
                        <script src="https://fastly.jsdelivr.net/gh/ITJoker233/ITJoker233.github.io@latest/CDN/js/hit-kounter-lc-0.3.0.js"></script>
                        <script src="https://cdn1.lncld.net/static/js/av-min-1.5.0.js"></script>
                        
                            <script>
                                (function() {
                                    var bp = document.createElement('script');
                                    var curProtocol = window.location.protocol.split(':')[0];
                                    if (curProtocol === 'https') {
                                        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
                                    } else {
                                        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
                                    }
                                    var s = document.getElementsByTagName("script")[0];
                                    s.parentNode.insertBefore(bp, s);
                                })();
                            </script>
                            
</head>

<body>
    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo">
                <a href="https://lzxzl.github.io">
                    ztree
                </a>
            </div>
            <div id="tp-weather-widget"></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/">
                        首页
                    </a>
                    
                    <a class="menu-item" href="/archives">
                        归档
                    </a>
                    
                    <a class="menu-item" href="/tags">
                        标签
                    </a>
                    
                    <a class="menu-item" href="/post/about">
                        关于
                    </a>
                    
                        <input id="switch_default" type="checkbox" class="switch_default">
                        <label for="switch_default" class="toggleBtn"></label>
            </div>
            <form id="gridea-search-form" data-update="1747748455692" action="/search/index.html">
                <input class="search-input" autocomplete="off" spellcheck="false" name="q" autofocus="true" placeholder="Search...">
            </form>
        </div>
    </nav>

    
        <nav class="navbar-mobile" id="nav-mobile">
            <div class="container">
                <div class="navbar-header">
                    <div>
                        <a href="https://lzxzl.github.io">
                            ztree
                        </a>
                        <!--en-->
                        <a id="mobile-toggle-theme-en" class="a en">&nbsp;Dark</a>
                        <!--zh-->
                        <a id="mobile-toggle-theme-zh" class="a zh">&nbsp;&#x6697;&#x9ED1;</a>
                    </div>
                    <form id="gridea-search-form" data-update="1747748455692" action="/search/index.html">
                        <input class="search-input" autocomplete="off" spellcheck="false" name="q" autofocus="true" placeholder="Search...">
                    </form>
                    <!--en-->
                    <div class="menu-toggle" id="menu-toggle-en" onclick="mobileBtn()">&#9776; Menu</div>
                    <!--zh-->
                    <div class="menu-toggle" id="menu-toggle-zh" onclick="mobileBtn()">&#9776; &#x83DC;&#x5355;</div>

                </div>
                <div class="menu" id="mobile-menu">
                    
                        <a class="menu-item" href="/">
                            首页
                        </a>
                        
                        <a class="menu-item" href="/archives">
                            归档
                        </a>
                        
                        <a class="menu-item" href="/tags">
                            标签
                        </a>
                        
                        <a class="menu-item" href="/post/about">
                            关于
                        </a>
                        
                </div>
            </div>
        </nav>
</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementById("menu-toggle-en");
        var toggleMenu_zh = document.getElementById("menu-toggle-zh");

        var mobileMenu = document.getElementById("mobile-menu");
        if (toggleMenu.display != "none") {
            if (toggleMenu.classList.contains("active")) {
                toggleMenu.classList.remove("active")
                mobileMenu.classList.remove("active")
            } else {
                toggleMenu.classList.add("active")
                mobileMenu.classList.add("active")
            }
        } else if (toggleMenu_zh.display != "none") {
            if (toggleMenu_zh.classList.contains("active")) {
                toggleMenu_zh.classList.remove("active")
                mobileMenu.classList.remove("active")
            } else {
                toggleMenu_zh.classList.add("active")
                mobileMenu.classList.add("active")
            }
        }

    }
</script>



    <script>
        (function(a, h, g, f, e, d, c, b) {
            b = function() {
                d = h.createElement(g);
                c = h.getElementsByTagName(g)[0];
                d.src = e;
                d.charset = "utf-8";
                d.async = 1;
                c.parentNode.insertBefore(d, c)
            };
            a["SeniverseWeatherWidgetObject"] = f;
            a[f] || (a[f] = function() {
                (a[f].q = a[f].q || []).push(arguments)
            });
            a[f].l = +new Date();
            if (a.attachEvent) {
                a.attachEvent("onload", b)
            } else {
                a.addEventListener("load", b, false)
            }
        }(window, document, "script", "SeniverseWeatherWidget", "//cdn.sencdn.com/widget2/static/js/bundle.js?t=" + parseInt((new Date().getTime() / 100000000).toString(), 10)));
        window.SeniverseWeatherWidget('show', {
            flavor: "slim",
            location: "WWEFQFPJZ7T8",
            geolocation: true,
            language: "auto",
            unit: "c",
            theme: "auto",
            token: "61bcc333-3305-4728-9465-6785274bb0a3",
            hover: "enabled",
            container: "tp-weather-widget"
        })
    </script>
    
            <div class="main">
                <div class="container">
                    <article class="post-wrap">
                        <header class="post-header">
                            <h1 class="post-title">
                                [翻译与学习] Let’s Build A Simple Interpreter. Part 10.
                            </h1>
                            
                                    <!--zh-->
                                    <div class="post-meta zh">
                                        &#x4F5C;&#x8005;:
                                        <a itemprop="author" rel="author" href="/">
                                            ztree
                                        </a>
                                        <span class="post-time">&#x65E5;&#x671F;: <a href="#">2021-12-06</a></span>
                                        <span class="post-readtime">&#x9605;&#x8BFB;&#x65F6;&#x95F4;:<a
                                    href="#">23.0
                                    &#x5206;&#x949F;</a></span>
                                        <span class="post-words">&#x5B57;&#x6570;:<a href="#">4642</a></span>
                                        
                                            <span class="post-category">&#x5206;&#x7C7B;:
                                
                                <a href="https://lzxzl.github.io/tag/GqQg6_YXk/">编译原理</a>
                                
                            </span>
                                            
                                                阅读量:
                                                <span data-hk-page="current"> - </span>
                                                
                                    </div>
                                    
                        </header>
                        
                        <div class="post-content">
                            <p>Today we will continue closing the gap between where we are right now and where we want to be: <a href="https://ruslanspivak.com/lsbasi-part1/">a fully functional interpreter for a subset of Pascal programming language</a>.</p>
<p>今天，我们将继续缩小我们现在所处的位置和我们想要达到的位置之间的差距: 一个用于 Pascal 编程语言子集的全功能解释器。</p>
<figure data-type="image" tabindex="1"><img src="https://ruslanspivak.com/lsbasi-part10/lsbasi_part10_intro.png" alt="" loading="lazy"></figure>
<p>In this article we will update our interpreter to parse and interpret our very first complete Pascal program. The program can also be compiled by the <a href="http://www.freepascal.org/">Free Pascal compiler, <em>fpc</em></a>.</p>
<p>在本文中，我们将更新我们的解释器来解析和解释我们的第一个完整的 Pascal 程序。该程序也可以通过Free Pascal compiler, fpc 编译。</p>
<p>Here is the program itself:</p>
<p>下面是程序:</p>
<pre><code class="language-pascal">PROGRAM Part10;
VAR
   number     : INTEGER;
   a, b, c, x : INTEGER;
   y          : REAL;

BEGIN {Part10}
   BEGIN
      number := 2;
      a := number;
      b := 10 * a + 10 * number DIV 4;
      c := a - - b
   END;
   x := 11;
   y := 20 / 7 + 3.14;
   { writeln('a = ', a); }
   { writeln('b = ', b); }
   { writeln('c = ', c); }
   { writeln('number = ', number); }
   { writeln('x = ', x); }
   { writeln('y = ', y); }
END.  {Part10}
</code></pre>
<p>Before we start digging into the details, download the source code of the interpreter from <a href="https://github.com/rspivak/lsbasi/blob/master/part10/python/spi.py">GitHub</a> and the <a href="https://github.com/rspivak/lsbasi/blob/master/part10/python/part10.pas">Pascal source code above</a>, and try it on the command line:</p>
<p>在我们开始深入研究细节之前，先从 GitHub 下载解释器的源代码和上面的 Pascal 源代码，然后在命令行上试一试:</p>
<pre><code class="language-shell">$ python spi.py part10.pas
a = 2
b = 25
c = 27
number = 2
x = 11
y = 5.99714285714
</code></pre>
<p>If I remove the comments around the <em>writeln</em> statements in the <a href="https://github.com/rspivak/lsbasi/blob/master/part10/python/part10.pas">part10.pas</a> file, compile the source code with <a href="http://www.freepascal.org/"><em>fpc</em></a> and then run the produced executable, this is what I get on my laptop:</p>
<p>如果我删除 part10.pas 文件中 writeln 语句周围的注释，用 fpc 编译源代码，然后运行生成的可执行文件，这就是我在笔记本电脑上得到的结果:</p>
<pre><code class="language-shell">$ fpc part10.pas
$ ./part10
a = 2
b = 25
c = 27
number = 2
x = 11
y =  5.99714285714286E+000
</code></pre>
<p>Okay, let’s see what we’re going cover today:</p>
<p>好的，让我们看看今天我们要学习什么:</p>
<ol>
<li>We will learn how to parse and interpret the Pascal <strong>_PROGRAM _</strong> header<br>
我们将学习如何解析和解释 Pascal PROGRAM header</li>
<li>We will learn how to parse Pascal variable declarations<br>
我们将学习如何解析 Pascal 变量声明</li>
<li>We will update our interpreter to use the <strong><em>DIV</em></strong> keyword for integer division and a forward slash / for float division<br>
我们将更新我们的解释器以使用DIV关键字表示整数除法，斜杠/表示浮点除法</li>
<li>We will add support for Pascal comments<br>
我们将增加对 Pascal 注释的支持</li>
</ol>
<p>Let’s dive in and look at the grammar changes first. Today we will add some new rules and update some of the existing rules. <img src="https://ruslanspivak.com/lsbasi-part10/lsbasi_part10_grammar1.png" alt="" loading="lazy"></p>
<p>让我们先深入研究一下语法的变化。今天我们将添加一些新的规则并更新一些现有的规则。</p>
<ol>
<li>The <em><strong>program</strong></em> definition grammar rule is updated to include the <em><strong>PROGRAM</strong></em> reserved keyword, the program name, and a block that ends with a dot. Here is an example of a complete Pascal program:<br>
_**program **_定义grammar规则被更新为包含 PROGRAM 保留关键字、程序名称和以点结尾的块。下面是一个完整的 Pascal 程序的例子:</li>
</ol>
<pre><code class="language-pascal">PROGRAM Part10;
BEGIN
END.
</code></pre>
<ol start="2">
<li>The <em><strong>block</strong></em> rule combines a <em>declarations</em> rule and a <em>compound_statement</em> rule. We’ll also use the rule later in the series when we add procedure declarations. Here is an example of a block:<br>
<strong><em>block</em></strong> 规则结合了一个 _declarations _规则和一个 _compound_statement _规则。在本系列后面添加 procedure declarations 时，我们还将使用该规则。下面是一个 block 的例子:</li>
</ol>
<pre><code class="language-pascal">VAR
   number : INTEGER;

BEGIN
END
</code></pre>
<p>Here is another example:<br>
下面是另一个例子:</p>
<pre><code class="language-pascal">BEGIN
END
</code></pre>
<ol start="3">
<li>Pascal declarations have several parts and each part is optional. In this article, we’ll cover the variable declaration part only. The <em><strong>declarations</strong></em> rule has either a variable declaration sub-rule or it’s empty.<br>
Pascal declarations 有几个部分，每个部分都是可选的。在本文中，我们将只讨论变量声明部分。声明规则要么有一个变量声明子规则，要么为空。</li>
<li>Pascal is a statically typed language, which means that every variable needs a variable declaration that explicitly specifies its type. In Pascal, variables must be declared before they are used. This is achieved by declaring variables in the program variable declaration section using the <em><strong>VAR</strong></em> reserved keyword. You can define variables like this:<br>
Pascal 是一种静态类型语言，这意味着每个变量都需要一个变量声明来明确指定它的类型。在 Pascal 语言中，变量在使用之前必须被声明。这是通过使用 VAR 保留关键字在程序变量声明部分中声明变量来实现的。你可以这样定义变量:</li>
</ol>
<pre><code class="language-pascal">VAR
   number     : INTEGER;
   a, b, c, x : INTEGER;
   y          : REAL;
</code></pre>
<ol start="5">
<li>The <em><strong>type_spec</strong></em> rule is for handling <em>INTEGER</em> and <em>REAL</em> types and is used in variable declarations. In the example below<br>
<strong>type_spec</strong> 规则用于处理 <strong><em>INTEGER</em></strong> 和 <strong><em>REAL</em></strong> 类型，并用于变量声明</li>
</ol>
<pre><code class="language-pascal">VAR
   a : INTEGER;
   b : REAL;
</code></pre>
<p>the variable “a” is declared with the type <em>INTEGER</em> and the variable “b” is declared with the type <em>REAL</em> (float). In this article we won’t enforce type checking, but we will add type checking later in the series.<br>
变量“ a”声明为 INTEGER 类型，变量“ b”声明为 REAL (float)类型。在本文中，我们不会强制执行类型检查，但是我们将在本系列的后面部分中添加类型检查。</p>
<ol start="6">
<li>The <em><strong>term</strong></em> rule is updated to use the <em><strong>DIV</strong></em> keyword for integer division and a forward slash / for float division.<br>
_**term **_规则更新为使用 <em><strong>DIV</strong></em> 关键字进行整数除法，使用正斜杠 / 进行浮点除法。<br>
Before, dividing 20 by 7 using a forward slash would produce an INTEGER 2:<br>
在此之前，20用正斜杠除以7会得到一个 INTEGER 2:<br>
Now, dividing 20 by 7 using a forward slash will produce a REAL (floating point number) 2.85714285714 :<br>
现在，用正斜杠除以20得到一个 REAL (浮点数)2.85714285714:<br>
From now on, to get an INTEGER instead of a REAL, you need to use the <em><strong>DIV</strong></em> keyword:<br>
从现在开始，为了得到一个 INTEGER 而不是 REAL，你需要使用 DIV 关键字:</li>
<li>The <em><strong>factor</strong></em> rule is updated to handle both integer and real (float) constants. I also removed the INTEGER sub-rule because the constants will be represented by <em><strong>INTEGER_CONST</strong></em> and <em><strong>REAL_CONST</strong></em> tokens and the <em><strong>INTEGER</strong></em> token will be used to represent the integer type. In the example below the lexer will generate an <em>INTEGER_CONST</em> token for 20 and 7 and a <em>REAL_CONST</em> token for 3.14 :<br>
_**factor **_规则被更新以处理整数和实数(浮点数)常量。我还删除了 INTEGER 子规则，因为常量将由  <em><strong>INTEGER_CONST</strong></em> 和 <em><strong>REAL_CONST</strong></em> token表示，而 INTEGER token将用于表示整数类型。在下面的例子中，lexer 将为20和7生成一个 <em><strong>INTEGER_CONST</strong></em>  token，为3.14生成一个 <em><strong>REAL_CONST</strong></em> token：</li>
</ol>
<p>Here is our complete grammar for today:</p>
<p>以下是我们今天的完整语法:</p>
<pre><code>    program : PROGRAM variable SEMI block DOT

    block : declarations compound_statement

    declarations : VAR (variable_declaration SEMI)+
                 | empty

    variable_declaration : ID (COMMA ID)* COLON type_spec

    type_spec : INTEGER | REAL

    compound_statement : BEGIN statement_list END

    statement_list : statement
                   | statement SEMI statement_list

    statement : compound_statement
              | assignment_statement
              | empty

    assignment_statement : variable ASSIGN expr

    empty :

    expr : term ((PLUS | MINUS) term)*

    term : factor ((MUL | INTEGER_DIV | FLOAT_DIV) factor)*

    factor : PLUS factor
           | MINUS factor
           | INTEGER_CONST
           | REAL_CONST
           | LPAREN expr RPAREN
           | variable

    variable: ID
</code></pre>
<p>In the rest of the article we’ll go through the same drill we went through last time:</p>
<p>在本文的其余部分，我们将重复上次的操作:</p>
<ol>
<li>Update the lexer 更新 lexer</li>
<li>Update the parser 更新解析器</li>
<li>Update the interpreter 更新解释器</li>
</ol>
<p><strong>Updating the Lexer</strong></p>
<p>Here is a summary of the lexer changes:</p>
<p>下面是 lexer 更改的摘要:</p>
<ol>
<li>New tokens<br>
新的tokens</li>
<li>New and updated reserved keywords<br>
新的和更新的保留关键字</li>
<li>New _skip_comment _ method to handle Pascal comments<br>
新的_skip_comment_方法来处理 Pascal 注释</li>
<li>Rename the _integer _method and make some changes to the method itself<br>
重命名 _integer _方法，并对方法本身进行一些更改</li>
<li>Update the _get_next_token _ method to return new tokens<br>
更新_get_next_token_方法以返回新的token</li>
</ol>
<p>Let’s dig into the changes mentioned above:</p>
<p>让我们深入研究一下上面提到的变化:</p>
<ol>
<li>To handle a program header, variable declarations, integer and float constants as well as integer and float division, we need to add some new tokens - some of which are reserved keywords - and we also need to update the meaning of the INTEGER token to represent the integer type and not an integer constant. Here is a complete list of new and updated tokens:<br>
为了处理程序头、变量声明、整数和浮点数常量以及整数和浮点数除法，我们需要添加一些新的token(其中一些是保留关键字) ，我们还需要更新 INTEGER token的含义，以表示整数类型，而不是整数常量。下面是新的和更新的token的完整列表:
<ul>
<li>PROGRAM (reserved keyword)</li>
<li>VAR (reserved keyword)</li>
<li>COLON (😃</li>
<li>COMMA (,)</li>
<li>INTEGER (we change it to mean integer type and not integer constant like 3 or 5)</li>
<li>REAL (for Pascal REAL type)</li>
<li>INTEGER_CONST (for example, 3 or 5)</li>
<li>REAL_CONST (for example, 3.14 and so on)</li>
<li>INTEGER_DIV for integer division (the <em><strong>DIV</strong></em> reserved keyword)</li>
<li>FLOAT_DIV for float division ( forward slash / )</li>
</ul>
</li>
<li>Here is the complete mapping of reserved keywords to tokens:<br>
下面是保留关键字到token的完整映射:</li>
</ol>
<pre><code class="language-python">RESERVED_KEYWORDS = {
    'PROGRAM': Token('PROGRAM', 'PROGRAM'),
    'VAR': Token('VAR', 'VAR'),
    'DIV': Token('INTEGER_DIV', 'DIV'),
    'INTEGER': Token('INTEGER', 'INTEGER'),
    'REAL': Token('REAL', 'REAL'),
    'BEGIN': Token('BEGIN', 'BEGIN'),
    'END': Token('END', 'END'),
}
</code></pre>
<ol start="3">
<li>We’re adding the <em>skip_comment</em> method to handle Pascal comments. The method is pretty basic and all it does is discard all the characters until the closing curly brace is found:<br>
我们添加了 <em>skip_comment</em> 方法来处理 Pascal 注释。这个方法非常简单，它所做的就是丢弃所有的字符，直到找到结束花括号:</li>
</ol>
<pre><code class="language-python">def skip_comment(self):
    while self.current_char != '}':
        self.advance()
    self.advance()  # the closing curly brace
</code></pre>
<ol start="4">
<li>We are renaming the <em>integer</em> method the <em>number</em> method. It can handle both integer constants and float constants like 3 and 3.14:<br>
我们将 _integer _方法重命名为 <em>number</em> 方法。它可以处理整型常量和浮点型常量，比如3和3.14:</li>
</ol>
<pre><code class="language-python">def number(self):
    &quot;&quot;&quot;Return a (multidigit) integer or float consumed from the input.&quot;&quot;&quot;
    result = ''
    while self.current_char is not None and self.current_char.isdigit():
        result += self.current_char
        self.advance()

    if self.current_char == '.':
        result += self.current_char
        self.advance()

        while (
            self.current_char is not None and
            self.current_char.isdigit()
        ):
            result += self.current_char
            self.advance()

        token = Token('REAL_CONST', float(result))
    else:
        token = Token('INTEGER_CONST', int(result))

    return token
</code></pre>
<ol start="5">
<li>We’re also updating the <em>get_next_token</em> method to return new tokens:<br>
我们还更新了  <em>get_next_token</em> 方法来返回新的令牌:</li>
</ol>
<pre><code class="language-python">def get_next_token(self):
    while self.current_char is not None:
        ...
        if self.current_char == '{':
            self.advance()
            self.skip_comment()
            continue
        ...
        if self.current_char.isdigit():
            return self.number()

        if self.current_char == ':':
            self.advance()
            return Token(COLON, ':')

        if self.current_char == ',':
            self.advance()
            return Token(COMMA, ',')
        ...
        if self.current_char == '/':
            self.advance()
            return Token(FLOAT_DIV, '/')
        ...
</code></pre>
<p><strong>Updating the Parser</strong></p>
<p>更新解析器</p>
<p>Now onto the parser changes.</p>
<p>现在转到解析器更改上。</p>
<p>Here is a summary of the changes:</p>
<p>以下是这些变化的摘要:<br>
​</p>
<ol>
<li>New AST nodes: <em>Program</em>, <em>Block</em>, <em>VarDecl</em>, <em>Type</em><br>
新的AST节点：<em>Program</em>, <em>Block</em>, <em>VarDecl</em>, <em>Type</em></li>
<li>New methods corresponding to new grammar rules: <em>block</em>, <em>declarations</em>, <em>variable_declaration</em>, and <em>type_spec</em>.<br>
对应新规则的新方法：<em>block</em>, <em>declarations</em>, <em>variable_declaration</em>, and _type_spec_​</li>
<li>Updates to the existing parser methods: <em>program</em>, <em>term</em>, and <em>factor</em><br>
更新现有的方法：<em>program</em>, <em>term</em>, and <em>factor</em></li>
</ol>
<p>Let’s go over the changes one by one:</p>
<p>让我们一个一个来看一下这些变化:</p>
<ol>
<li>We’ll start with new AST nodes first. There are four new nodes:<br>
我们首先从新的 AST 节点开始，有四个新节点:
<ul>
<li>The <em>Program</em> AST node represents a program and will be our root node<br>
Program AST 节点表示一个程序，将是我们的根节点</li>
</ul>
</li>
</ol>
<pre><code class="language-python">class Program(AST):
    def __init__(self, name, block):
        self.name = name
        self.block = block
</code></pre>
<ul>
<li>The <em>Block</em> AST node holds declarations and a compound statement:<br>
Block AST 节点包含声明和一个复合语句:</li>
</ul>
<pre><code class="language-python">class Block(AST):
    def __init__(self, declarations, compound_statement):
        self.declarations = declarations
        self.compound_statement = compound_statement
</code></pre>
<ul>
<li>The <em>VarDecl</em> AST node represents a variable declaration. It holds a variable node and a type node:<br>
_VarDecl _AST 节点表示一个变量声明，它包含一个变量节点和一个类型节点:</li>
</ul>
<pre><code class="language-python">class VarDecl(AST):
    def __init__(self, var_node, type_node):
        self.var_node = var_node
        self.type_node = type_node
</code></pre>
<ul>
<li>The <em>Type</em> AST node represents a variable type (INTEGER or REAL):<br>
Type AST 节点表示一个变量类型(INTEGER 或 REAL) :</li>
</ul>
<pre><code class="language-python">class Type(AST):
    def __init__(self, token):
        self.token = token
        self.value = token.value
</code></pre>
<ol start="2">
<li>As you probably remember, each rule from the grammar has a corresponding method in our recursive-descent parser. Today we’re adding four new methods: <em>block</em>, <em>declarations</em>, <em>variable_declaration</em>, and <em>type_spec</em>. These methods are responsible for parsing new language constructs and constructing new AST nodes:<br>
您可能还记得，在我们的递归下降分析器中，文法中的每个规则都有一个对应的方法。今天我们添加了四个新方法: block、 declaration、 <em>variable_declaration</em> 和 <em>type_spec</em>。这些方法负责解析新的语言结构并构造新的 AST 节点:</li>
</ol>
<pre><code class="language-python">def block(self):
    &quot;&quot;&quot;block : declarations compound_statement&quot;&quot;&quot;
    declaration_nodes = self.declarations()
    compound_statement_node = self.compound_statement()
    node = Block(declaration_nodes, compound_statement_node)
    return node

def declarations(self):
    &quot;&quot;&quot;declarations : VAR (variable_declaration SEMI)+
                    | empty
    &quot;&quot;&quot;
    declarations = []
    if self.current_token.type == VAR:
        self.eat(VAR)
        while self.current_token.type == ID:
            var_decl = self.variable_declaration()
            declarations.extend(var_decl)
            self.eat(SEMI)

    return declarations

def variable_declaration(self):
    &quot;&quot;&quot;variable_declaration : ID (COMMA ID)* COLON type_spec&quot;&quot;&quot;
    var_nodes = [Var(self.current_token)]  # first ID
    self.eat(ID)

    while self.current_token.type == COMMA:
        self.eat(COMMA)
        var_nodes.append(Var(self.current_token))
        self.eat(ID)

    self.eat(COLON)

    type_node = self.type_spec()
    var_declarations = [
        VarDecl(var_node, type_node)
        for var_node in var_nodes
    ]
    return var_declarations

def type_spec(self):
    &quot;&quot;&quot;type_spec : INTEGER
                 | REAL
    &quot;&quot;&quot;
    token = self.current_token
    if self.current_token.type == INTEGER:
        self.eat(INTEGER)
    else:
        self.eat(REAL)
    node = Type(token)
    return node
</code></pre>
<ol start="3">
<li>We also need to update the <em>program</em>, <em>term</em>, and, <em>factor</em> methods to accommodate our grammar changes:<br>
我们还需要更新_program_、_term _和 factor 方法，以适应我们的语法变化:</li>
</ol>
<pre><code class="language-python">def program(self):
    &quot;&quot;&quot;program : PROGRAM variable SEMI block DOT&quot;&quot;&quot;
    self.eat(PROGRAM)
    var_node = self.variable()
    prog_name = var_node.value
    self.eat(SEMI)
    block_node = self.block()
    program_node = Program(prog_name, block_node)
    self.eat(DOT)
    return program_node

def term(self):
    &quot;&quot;&quot;term : factor ((MUL | INTEGER_DIV | FLOAT_DIV) factor)*&quot;&quot;&quot;
    node = self.factor()

    while self.current_token.type in (MUL, INTEGER_DIV, FLOAT_DIV):
        token = self.current_token
        if token.type == MUL:
            self.eat(MUL)
        elif token.type == INTEGER_DIV:
            self.eat(INTEGER_DIV)
        elif token.type == FLOAT_DIV:
            self.eat(FLOAT_DIV)

        node = BinOp(left=node, op=token, right=self.factor())

    return node

def factor(self):
    &quot;&quot;&quot;factor : PLUS factor
              | MINUS factor
              | INTEGER_CONST
              | REAL_CONST
              | LPAREN expr RPAREN
              | variable
    &quot;&quot;&quot;
    token = self.current_token
    if token.type == PLUS:
        self.eat(PLUS)
        node = UnaryOp(token, self.factor())
        return node
    elif token.type == MINUS:
        self.eat(MINUS)
        node = UnaryOp(token, self.factor())
        return node
    elif token.type == INTEGER_CONST:
        self.eat(INTEGER_CONST)
        return Num(token)
    elif token.type == REAL_CONST:
        self.eat(REAL_CONST)
        return Num(token)
    elif token.type == LPAREN:
        self.eat(LPAREN)
        node = self.expr()
        self.eat(RPAREN)
        return node
    else:
        node = self.variable()
        return node
</code></pre>
<p>Now, let’s see what the <em><strong>Abstract Syntax Tree</strong></em> looks like with the new nodes. Here is a small working Pascal program:</p>
<p>现在，让我们来看看使用这些新节点后的抽象语法树是什么样子的。下面是一个小型的 Pascal 程序:</p>
<pre><code class="language-pascal">PROGRAM Part10AST;
VAR
   a, b : INTEGER;
   y    : REAL;

BEGIN {Part10AST}
   a := 2;
   b := 10 * a + 10 * a DIV 4;
   y := 20 / 7 + 3.14;
END.  {Part10AST}
</code></pre>
<p>Let’s generate an AST and visualize it with the <a href="https://github.com/rspivak/lsbasi/blob/master/part10/python/genastdot.py">genastdot.py</a>:</p>
<p>让我们生成一个 AST，并用 genastdot.py 将其可视化:</p>
<p>$ python genastdot.py part10ast.pas &gt; ast.dot &amp;&amp; dot -Tpng -o ast.png ast.dot</p>
<figure data-type="image" tabindex="2"><img src="https://ruslanspivak.com/lsbasi-part10/lsbasi_part10_ast.png" alt="" loading="lazy"></figure>
<p>In the picture you can see the new nodes that we have added.</p>
<p>在图中可以看到我们添加的新节点。</p>
<p><strong>Updating the Interpreter</strong></p>
<p>更新解释器</p>
<p>We’re done with the lexer and parser changes. What’s left is to add new visitor methods to our <em>Interpreter</em> class. There will be four new methods to visit our new nodes:</p>
<p>我们已经完成了 lexer 和解析器的更改。剩下的工作是向我们的 Interpreter 类添加新的 visitor 方法。将有四种新方法访问我们的新节点:</p>
<ul>
<li><em>visit_Program</em></li>
<li><em>visit_Block</em></li>
<li><em>visit_VarDecl</em></li>
<li><em>visit_Type</em></li>
</ul>
<p>They are pretty straightforward. You can also see that the <em>Interpreter</em> does nothing with <em>VarDecl</em> and <em>Type</em> nodes:</p>
<p>你也可以看到 Interpreter 对 VarDecl 和 Type 节点什么也不做:</p>
<pre><code class="language-python">def visit_Program(self, node):
    self.visit(node.block)

def visit_Block(self, node):
    for declaration in node.declarations:
        self.visit(declaration)
    self.visit(node.compound_statement)

def visit_VarDecl(self, node):
    # Do nothing
    pass

def visit_Type(self, node):
    # Do nothing
    pass
</code></pre>
<p>We also need to update the <em>visit_BinOp</em> method to properly interpret integer and float divisions:</p>
<p>我们还需要更新 <em>visit_BinOp</em> 方法来正确解释整数和浮点数部分:</p>
<pre><code class="language-python">def visit_BinOp(self, node):
    if node.op.type == PLUS:
        return self.visit(node.left) + self.visit(node.right)
    elif node.op.type == MINUS:
        return self.visit(node.left) - self.visit(node.right)
    elif node.op.type == MUL:
        return self.visit(node.left) * self.visit(node.right)
    elif node.op.type == INTEGER_DIV:
        return self.visit(node.left) // self.visit(node.right)
    elif node.op.type == FLOAT_DIV:
        return float(self.visit(node.left)) / float(self.visit(node.right))
</code></pre>
<p>Let’s sum up what we had to do to extend the Pascal interpreter in this article:</p>
<p>让我们总结一下我们在本文中为扩展 Pascal 解释器所做的工作:</p>
<ul>
<li>Add new rules to the grammar and update some existing rules
<ul>
<li>向语法中添加新规则并更新一些现有规则</li>
</ul>
</li>
<li>Add new tokens and supporting methods to the lexer, update and modify some existing methods
<ul>
<li>向 lexer 添加新的token和支持方法，更新和修改一些现有的方法</li>
</ul>
</li>
<li>Add new AST  nodes to the parser for new language constructs
<ul>
<li>添加新的AST节点到解析器以解析新语言结构</li>
</ul>
</li>
<li>Add new methods corresponding to the new grammar rules to our recursive-descent parser and update some existing methods
<ul>
<li>在我们的递归下降分析器中添加与新文法规则相对应的新方法，并更新一些现有的方法</li>
</ul>
</li>
<li>Add new visitor methods to the interpreter and update one existing visitor method
<ul>
<li>向解释器添加新的visitor方法并更新一个现有的visitor方法</li>
</ul>
</li>
</ul>
<p>As a result of our changes we also got rid of some of the hacks I introduced in <a href="https://ruslanspivak.com/lsbasi-part9/">Part 9</a>, namely:</p>
<p>作为修改的结果，我们还删除了我在第9部分介绍的一些hacks，即:</p>
<ul>
<li>Our interpreter can now handle the <em>**PROGRAM **</em> header
<ul>
<li>解释器现在可以处理_**PROGRAM **_ header</li>
</ul>
</li>
<li>Variables can now be declared using the <em><strong>VAR</strong></em> keyword
<ul>
<li>变量现在可以使用VAR关键字声明了</li>
</ul>
</li>
<li>The <em><strong>DIV</strong></em> keyword is used for integer division and a forward slash / is used for float division
<ul>
<li>DIV 关键字用于整数除法，正斜杠/用于浮点除法</li>
</ul>
</li>
</ul>
<p>If you haven’t done so yet, then, as an exercise, re-implement the interpreter in this article without looking at the source code and use <a href="https://github.com/rspivak/lsbasi/blob/master/part10/python/part10.pas">part10.pas</a> as your test input file.</p>
<p>如果您还没有这样做，那么，作为练习，在本文中重新实现解释器，不要查看源代码，并使用 part10.pas 作为您的测试输入文件。</p>
<p>That’s all for today. In the next article, I’ll talk in greater detail about symbol table management. Stay tuned and see you soon!</p>
<p>今天就到这里吧。在下一篇文章中，我将更详细地讨论符号表管理。请继续关注，我们很快就会再见！</p>
<p><strong>All articles in this series:</strong></p>
<p>本系列的所有文章:</p>
<ul>
<li><a href="https://ruslanspivak.com/lsbasi-part1/">Let's Build A Simple Interpreter. Part 1. 让我们构建一个简单的解释器</a></li>
<li><a href="https://ruslanspivak.com/lsbasi-part2/">Let's Build A Simple Interpreter. Part 2. 让我们构建一个简单的解释器</a></li>
<li><a href="https://ruslanspivak.com/lsbasi-part3/">Let's Build A Simple Interpreter. Part 3. 让我们构建一个简单的解释器</a></li>
<li><a href="https://ruslanspivak.com/lsbasi-part4/">Let's Build A Simple Interpreter. Part 4. 让我们构建一个简单的解释器</a></li>
<li><a href="https://ruslanspivak.com/lsbasi-part5/">Let's Build A Simple Interpreter. Part 5. 让我们构建一个简单的解释器</a></li>
<li><a href="https://ruslanspivak.com/lsbasi-part6/">Let's Build A Simple Interpreter. Part 6. 让我们构建一个简单的解释器</a></li>
<li><a href="https://ruslanspivak.com/lsbasi-part7/">Let's Build A Simple Interpreter. Part 7: Abstract Syntax Trees 让我们构建一个简单的解释器。第7部分: 抽象语法树</a></li>
<li><a href="https://ruslanspivak.com/lsbasi-part8/">Let's Build A Simple Interpreter. Part 8. 让我们构建一个简单的解释器</a></li>
<li><a href="https://ruslanspivak.com/lsbasi-part9/">Let's Build A Simple Interpreter. Part 9. 让我们构建一个简单的解释器</a></li>
<li><a href="https://ruslanspivak.com/lsbasi-part10/">Let's Build A Simple Interpreter. Part 10. 让我们构建一个简单的解释器</a></li>
<li><a href="https://ruslanspivak.com/lsbasi-part11/">Let's Build A Simple Interpreter. Part 11. 让我们构建一个简单的解释器</a></li>
<li><a href="https://ruslanspivak.com/lsbasi-part12/">Let's Build A Simple Interpreter. Part 12. 让我们构建一个简单的解释器</a></li>
<li><a href="https://ruslanspivak.com/lsbasi-part13/">Let's Build A Simple Interpreter. Part 13: Semantic Analysis 让我们建立一个简单的解释器。第13部分: 语义分析</a></li>
<li><a href="https://ruslanspivak.com/lsbasi-part14/">Let's Build A Simple Interpreter. Part 14: Nested Scopes and a Source-to-Source Compiler 让我们构建一个简单的解释器。第14部分: 嵌套作用域和源到源编译器</a></li>
<li><a href="https://ruslanspivak.com/lsbasi-part15/">Let's Build A Simple Interpreter. Part 15. 让我们构建一个简单的解释器。第15部分</a></li>
<li><a href="https://ruslanspivak.com/lsbasi-part16/">Let's Build A Simple Interpreter. Part 16: Recognizing Procedure Calls 让我们建立一个简单的解释器。第16部分: 识别过程调用</a></li>
<li><a href="https://ruslanspivak.com/lsbasi-part17/">Let's Build A Simple Interpreter. Part 17: Call Stack and Activation Records 让我们构建一个简单的解释器。第17部分: 调用堆栈和激活记录</a></li>
<li><a href="https://ruslanspivak.com/lsbasi-part18/">Let's Build A Simple Interpreter. Part 18: Executing Procedure Calls 让我们构建一个简单的解释器。第18部分: 执行过程调用</a></li>
<li><a href="https://ruslanspivak.com/lsbasi-part19/">Let's Build A Simple Interpreter. Part 19: Nested Procedure Calls 让我们构建一个简单的解释器。第19部分: 嵌套过程调用</a></li>
</ul>

                        </div>
                        
                            <div class="post-toc">
                                
                            </div>
                            
                                
                                    
                                            <!--zh-->
                                            <section class="post-copyright zh">
                                                <p class="copyright-item ">
                                                    <span>&#x4F5C;&#x8005;:</span>
                                                    <span>ztree</span>
                                                </p>

                                                <p class="copyright-item">
                                                    <span>&#x6C38;&#x4E45;&#x94FE;&#x63A5;:</span>
                                                    <span><a href="https://lzxzl.github.io/post/fan-yi-yu-xue-xi-lets-build-a-simple-interpreter-part-10/">https://lzxzl.github.io/post/fan-yi-yu-xue-xi-lets-build-a-simple-interpreter-part-10/</a></span>
                                                </p>

                                                <p class="copyright-item">
                                                    <span>&#x534F;&#x8BAE;:</span>
                                                    <span>MIT License</span>
                                                </p>
                                            </section>
                                            
                                                
                                                    
                                                                    <!--Share-->
                                                                    <span style="margin-right:15px">
                        <i class="post-share"></i>
                        <span>&#x5206;&#x4EAB;:</span>
                                                                    <a title="QR 码" target="_blank" href="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=https://lzxzl.github.io/post/fan-yi-yu-xue-xi-lets-build-a-simple-interpreter-part-10/"><i class="fa fa-qrcode"></i></a>
                                                                    <a title="QQ" target="_blank" href="https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=https://lzxzl.github.io/post/fan-yi-yu-xue-xi-lets-build-a-simple-interpreter-part-10/&sharesource=qzone&title=[翻译与学习] Let’s Build A Simple Interpreter. Part 10.&pics=https://lzxzl.github.io/images/avatar.png?v=1747748455692&summary="><i class="fa fa-qq"></i></a>
                                                                    <a title="新浪微博" target="_blank" href="https://service.weibo.com/share/share.php?url=https://lzxzl.github.io/post/fan-yi-yu-xue-xi-lets-build-a-simple-interpreter-part-10/&sharesource=weibo&title=[翻译与学习] Let’s Build A Simple Interpreter. Part 10. + " - " + &pic="https://lzxzl.github.io/images/avatar.png?v=1747748455692 "><i class="fa fa-weibo "></i></a>

                                                                    </span>
                                                                    
                                                                            <!--zh-->
                                                                            <section class="post-tags zh ">
                                                                                <div>
                                                                                    <span>&#x6807;&#x7B7E;:</span>
                                                                                    <span class="tag ">
                        
                        
                        <a href="https://lzxzl.github.io/tag/GqQg6_YXk/">#
                    编译原理
                        </a>
                        
                            
                                </span>
                                                                                </div>
                                                                                <div>
                                                                                    <a href="javascript:window.history.back();">
                        &#x8FD4;&#x56DE;</a>
                                                                                    <span>&dot;</span>
                                                                                    <a href="#">&#x4E3B;&#x9875;</a>
                                                                                </div>
                                                                            </section>

                                                                            
                                                                                <!---->
                                                                                <section class="post-nav">
                                                                                    
                                                                                        <a class="prev" rel="prev" href="https://lzxzl.github.io/post/fan-yi-yu-xue-xi-lets-build-a-simple-interpreter-part-11/">
                                                                                            [翻译与学习] Let&#39;s Build A Simple Interpreter. Part 11.
                                                                                        </a>
                                                                                        
                                                                                            
                                                                                                <a class="next" rel="next" href="https://lzxzl.github.io/post/fan-yi-yu-xue-xi-lets-build-a-simple-interpreter-part-9/">
                                                                                                    [翻译与学习] Let&#39;s Build A Simple Interpreter. Part 9
                                                                                                </a>
                                                                                                
                                                                                </section>
                    </article>
                </div>
                
                    
                        <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>

<div id="gitalk-container" style="width: 100%;max-width: 780px;margin: auto;"></div>

<script>
    var gitalk = new Gitalk({
        clientID: '2a44a295dd16ae7d05b8',
        clientSecret: '8030257bc11446a193cf383767567daca0e26312',
        repo: 'lzxzl.github.io',
        owner: 'lzxzl',
        admin: ['lzxzl'],
        id: (location.pathname).substring(0, 49), // Ensure uniqueness and length less than 50
        distractionFreeMode: false // Facebook-like distraction free mode
    })

    gitalk.render('gitalk-container')
</script>
                            
                                        
                                            
            </div>
    </div>
    </div>
    </div>
    
        <footer id="footer" class="footer">
            <div class="copyright">
                
                        ztree
                            
                                        <svg viewBox="0 0 1024 1024" style="margin-left: 5px;margin-right: 5px;" version="1.0" width="8" height="8" class="my-face">
            <path
                d="M863.597631 513.574282l-271.33965-140.213484L729.783667 81.926656c3.583731-7.87141 7.167462-15.742819 7.167462-25.214109C736.887134 25.226908 708.345275 0.012799 672.635953 0.012799a63.611229 63.611229 0 0 0-39.293053 12.607055c-1.791866 1.59988-3.519736 3.19976-5.311602 3.19976L147.87531 418.925381a55.547834 55.547834 0 0 0-19.646527 47.356448c1.791866 17.278704 14.27093 33.021523 32.125591 42.492813l271.33965 141.749369L292.504463 945.221908c-12.479064 25.214109-1.791866 53.563983 23.166262 69.306802 10.751194 6.335525 23.230258 9.47129 35.709322 9.47129 16.062795 0 32.125591-4.735645 44.604655-15.742819l480.091993-403.297753a55.547834 55.547834 0 0 0 19.646526-47.228458 61.243407 61.243407 0 0 0-32.12559-44.156688z"
                fill="#93b5cf"></path>
        </svg>
                                        ztree &copy;Copyright
                                            <script>
                                                var date = new Date();
                                                document.write("" + date.getFullYear());
                                            </script>
                                            | Powered by
                                            <a href="https://lzxzl.github.io/" target="_blank">
                                                ztree
                                            </a>
            </div>
            <div id="update" style="display:none;">
                off
            </div>
            
                    <script>
                        var port = '';
                        
                        document.write('<div id="home_path" style="display:none;">' + document.location.protocol + '//' + window.document.location.hostname + port + '</div>')
                    </script>
        </footer>
        
                <script>
                    
                    
                    
                    getStar();
                    hljs.initHighlighting();
                    console.clear();
                    
                    var newDate = new Date();
                    newDate.setTime(1747748455692);
                    console.log(" Blog Update Time: " + newDate.toLocaleDateString());
                    console.log("\n %c \u26a1Theme:Chic Author's Blog:https://blog.itjoker.cn  Write By ITJoker  \n\n", "color: #ffffff; background: rgba(49, 49, 49, 0.85); padding:5px 0;border-radius:5px;");
                </script>
        </div>
</body>
<script>
    scroll();
</script>

</html>